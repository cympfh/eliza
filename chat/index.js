// Generated by CoffeeScript 1.7.1
(function() {
  var abs, append_marks, load, log, make, max, min, model_path, mutter, noun, pp, random, reply, round, warn, _ref;

  pp = require('./poppush');

  noun = require('./noun');

  append_marks = require('./append_marks');

  _ref = require('./ngram'), load = _ref.load, make = _ref.make, model_path = _ref.model_path;

  random = Math.random, round = Math.round, log = Math.log, abs = Math.abs, min = Math.min, max = Math.max;

  warn = console.warn;

  load(model_path);

  reply = function(text, cont) {
    var msg, pr, pr0;
    text = text.replace(/@[\sa-zA-Z0-9_]*/g, '');
    text = text.trim();
    pr = random();
    pr0 = 0.8;
    if (pr < pr0 && (pp.popp())) {
      warn("## reply with pop");
      pp.pop(cont);
      return;
    }
    pr -= pr0;
    if (pr < 0.3) {
      warn("## reply with ngram");
      msg = make();
      cont(msg);
      return;
    }
    return noun(text, function(result) {
      warn("## reply with noun");
      if (result.status === 'successed') {
        return cont(result.msg);
      } else {
        warn("### No. that failed. we using append_marks");
        msg = append_marks(text);
        return cont(msg);
      }
    });
  };

  mutter = function(cont) {
    var pr;
    warn("## Eliza muttering");
    pr = pp.popp();
    if (pr > 0.9) {
      warn("### with pop");
      return pp.pop(cont);
    } else {
      warn("### with ngram");
      return cont(make());
    }
  };

  module.exports = {
    push: pp.push,
    reply: reply,
    mutter: mutter
  };

}).call(this);
